CREATE DEFINER=`root`@`localhost` PROCEDURE `SetNumberDoc`(numberDocIN VARCHAR(4), OUT id_doc VARCHAR(45))
    SQL SECURITY INVOKER
BEGIN	
	DECLARE countNumber INT; 
    DECLARE id_number INT; #id записи в которой есть номер numberDocIN  RefreshBasket() id_doc
    DECLARE today DATE;
    DECLARE MaxNumber VARCHAR(4);        #максимальный номер документа из deleted_sn и service_note
    DECLARE MaxNumberFromSN VARCHAR(4);  #максимальный номер документа из service_note
    DECLARE MaxNumberFromDT VARCHAR(4);  #максимальный номер документа из deleted_sn

	#начнем транзакцию
	START TRANSACTION;
    SET AUTOCOMMIT=0;

	SELECT COUNT(*) FROM service_note WHERE count_sn = numberDocIN INTO countNumber;
    
    SELECT MAX(count_sn) FROM service_note INTO MaxNumberFromSN;
    SELECT MAX(count_sn) FROM deleted_sn INTO MaxNumberFromDT;
    
    #Вычисляем максимальное число
    IF(MaxNumberFromSN >= MaxNumberFromDT) THEN
		SELECT MaxNumberFromSN INTO MaxNumber;
	ELSE
		SELECT MaxNumberFromDT INTO MaxNumber;
    END IF;
    	
    If (!countNumber) THEN #если ничего не нашли, то    		
        
        #Записываем номер
        SELECT CURDATE() INTO today; #&&&????
        INSERT INTO service_note (count_sn, service_note.number_sn, name_sn, destination, user, date)
		VALUES (numberDocIN, numberDocIN, "Документ", null, null,  today);     
		
        #Если записываемое значение больше всех максимальных значение, то очищаем таблицу deleted_sn
        IF(numberDocIN >= MaxNumber) THEN
			CALL RefreshBasket();
		END IF;
        
        #теперь если данный номер существует в таблице deleted_sn
        SELECT id_deleted_sn FROM deleted_sn WHERE count_sn = numberDocIN INTO id_number;
        IF(id_number) THEN #если существуе, то нужно удалить        
			DELETE FROM deleted_sn WHERE id_deleted_sn = id_number;
        END IF;
        
        SELECT id_sn FROM service_note WHERE count_sn = numberDocIN INTO id_doc;
    ELSE
		SELECT null INTO id_doc; #На всякий случай обнуляем
    END IF;
    
    
	#Проверяем нет ли данного номера в service_note и в deleted_sn
    #Если нет, то
		#Находим наибольший номер в данных таблицах
		#Если numberDocIN больше наибольшего номера, то удаляем все номера из deleted_sn и записываем в таблицу service_note
		#Если нет, то записываем в таблицу service_note
        
	COMMIT;
    SET AUTOCOMMIT=1;
END